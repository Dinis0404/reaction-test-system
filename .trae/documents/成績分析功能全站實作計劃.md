## 功能總覽
- 目標：在網站新增「成績分析」能力，涵蓋成績收集、統計分析、可視化展示、導出/導入與用戶權限控制，並與既有測驗流程無縫整合。
- 技術棧：Next.js 14、React 18、TypeScript、Tailwind CSS；前端本地保存（localStorage），可選 DeepSeek AI 分析。

## 架構設計
- 數據管道：QuizContainer 完成練習 → 收到 `/api/quiz/complete` 結果 → 調用 `lib/analytics.saveResult(...)` → 以 localStorage 持久化 → 報表頁 `pages/report.tsx` 讀取與分析。
- 模組劃分：
  - 成績收集：`lib/analytics.ts`、`lib/storage.ts`
  - 統計分析：`lib/analytics.ts`（純函式，含計算與聚合）
  - 視覺化：`components/Report/*` 組件（趨勢、分類、錯題、總覽卡片）
  - 導出/導入：`components/Report/ExportImportControls.tsx`
  - 權限控制：`lib/permissions.ts` + `components/AuthGate.tsx`
  - AI 分析（選配）：`pages/api/analysis/deepseek.ts` 與結果頁觸發按鈕

## 數據模型
- 成績記錄（ResultRecord）：
  - `id`、`sessionId`、`timestamp`、`score`、`correctCount`、`totalQuestions`
  - `selectedFiles`（來源檔案路徑陣列）、`folder`（頂層分類）
  - `results`（每題 `questionId`、`selectedIndex`、`correctIndex`、`isCorrect`）
- 儲存鍵：`localStorage['quiz_results']`（JSON 陣列，含版本號 `schemaVersion`）

## 成績數據收集模組
- 新增 `lib/storage.ts`：安全讀寫 localStorage、版本遷移、防空資料與容量保護。
- 新增 `lib/analytics.ts`：
  - `saveResult(summary, results, context)`：生成 ResultRecord、追加保存
  - `getAllResults()`：讀取全部紀錄
  - `computeOverview(records)`：平均分、次數、最近分數
  - `computeByCategory(records)`：english/math/chinese/other 指標
  - `computeTrend(records, limit)`：近 N 次分數序列
  - `computeWrongTop(records, limit)`：錯題排行榜與選項分佈
- 整合點：在 `QuizContainer.submitAllAnswers` 成功後調用 `saveResult(...)`

## 成績統計分析引擎
- 純函式、可測試：避免副作用、可擴充維度（題型、時間段、文件標籤）。
- 性能策略：
  - 懶計算與結果緩存（memoization）
  - 大資料量下分頁/窗口計算（trend 限制近 N 次）
  - 計算量大時可引入 Web Worker（後續擴充）

## 可視化展示界面
- 新頁面：`pages/report.tsx`
  - `ReportDashboard.tsx`：總覽卡（平均分、次數、最近分數）
  - `TrendChart.tsx`：近 N 次分數折線（初期用 SVG/簡單圖）
  - `CategoryBreakdown.tsx`：分類正確率條形圖
  - `WrongQuestionList.tsx`：錯題清單與頻率/最近錯誤時間
  - `ExportImportControls.tsx`：JSON 導出/導入
- 導航入口：
  - 結果頁新增「查看成績分析」按鈕跳轉 `/report`
  - 首頁可選加入「成績分析」入口
- UI/UX：延續深色主題、卡片式布局、響應式網格、可及性（鍵盤與螢幕閱讀器）

## 數據導出/導入
- 導出：將 `quiz_results` 下載為 `results-YYYYMMDD.json`
- 導入：選檔解析、schema 檢查與版本遷移、合併去重（以 `id`）
- 錯誤處理：格式錯誤提示、預覽合併影響

## 用戶權限控制
- 輕量本地角色：`roles: ['viewer','owner']`
- 設定：首次進入報表頁，可設定或輸入本地「管理 PIN」（SHA-256 雜湊保存於 localStorage）
- 權限策略：
  - `viewer`：瀏覽分析
  - `owner`：允許導出/導入與清除資料
- 組件：`components/AuthGate.tsx` 包裹敏感操作

## 錯誤處理與穩健性
- 前端：所有 IO/解析/計算函式加 try/catch、錯誤 UI 提示與重試
- API（DeepSeek）：回傳非 2xx 時顯示可讀錯誤、節流與超時保護
- 儲存：localStorage 容量監測、超過限制時提示與清理策略

## 性能優化
- 計算：懶載入、分頁/窗口、memo 化
- 渲染：按需渲染（虛擬列表用於長清單）、避免大型圖表初次渲染阻塞
- 資料量：在數千筆級別保持互動順暢（目標 < 50ms 主執行緒計算）

## 測試計劃
- 單元測試：`lib/analytics.ts` 的聚合/統計函式，涵蓋邊界與錯誤路徑
- 端到端：使用 Playwright/Testing Library 驗證完整流程（做題 → 完成 → 保存 → 報表展示 → 導出/導入）
- 相容性：桌面/平板/手機三檔斷點與主要瀏覽器
- 性能基準：基於 1k、5k、10k 筆記錄測試計算與渲染時間

## 交付物
- 完整可用的成績分析功能（頁面、模組、入口）
- 更新技術文件（README/架構說明/資料結構）
- 測試報告（單元、E2E、相容性、性能）
- 用戶操作手冊（如何查看、導出/導入、權限設定）

## 實作清單（文件級）
- 新增：`lib/storage.ts`、`lib/analytics.ts`、`lib/permissions.ts`
- 新增：`pages/report.tsx`
- 新增：`components/Report/ReportDashboard.tsx`、`TrendChart.tsx`、`CategoryBreakdown.tsx`、`WrongQuestionList.tsx`、`ExportImportControls.tsx`、`AuthGate.tsx`
- 更新：`components/QuizContainer.tsx`（提交成功後保存成績、入口按鈕）
- （選配）API：`pages/api/analysis/deepseek.ts` 使用環境變數 `DEEPSEEK_API_KEY`
- 測試：`__tests__/analytics.test.ts`、E2E 腳本

## 確認事項
- 權限控制採本地 PIN 方案是否可接受；如需真正帳號登入，再擴充認證方案
- DeepSeek 分析是否作為可選（按鈕觸發）即可；是否需要自動分析
- 圖表庫是否保持原生/輕量，或可引入第三方（如 Chart.js）
